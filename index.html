<html>
    <head>
        <title>Asky - ASCII Image Generator</title>
        <script>
            window.addEventListener('DOMContentLoaded', (event) => {
                loadImage();
            });

            function loadImage() {
                let imageName = 'yoshi.png';
                let sourceImage = new Image();
                sourceImage.crossOrigin = 'anonymous';
                sourceImage.src = imageName;
                let canvasElement = document.getElementById('sourceImage');
                let canvasContext = canvasElement.getContext('2d');
                let sourceImagePixelArray = [];

                sourceImage.onload = function() {
                    canvasElement.width = this.naturalWidth; // set canvas to image size
                    canvasElement.height = this.naturalHeight;

                    let sourceImageWidth = canvasElement.width;
                    let sourceImageHeight = canvasElement.height;

                    canvasContext.drawImage(sourceImage, 0, 0);

                    let sourceImageData = canvasContext.getImageData(0, 0, sourceImageWidth, sourceImageHeight).data;
                    sourceImagePixelArray = readImageData(sourceImageData, sourceImageWidth, sourceImageHeight);

                    let imageAsciiArray = getAsciiArray(sourceImagePixelArray, sourceImageWidth, sourceImageHeight);

                    outputAsciiArray(imageAsciiArray);
                };
            }

            function readImageData(imageData, imageWidth, imageHeight) {
                let imagePixelArray = [];
                let currentPositionColumn = 0;
                let currentRowPixels = [];
                for (let i = 0; i < imageData.length; i += 4) {
                    currentPixel = new Pixel(imageData[i + 0], imageData[i + 1], imageData[i + 2], imageData[i + 3]);
                    currentRowPixels.push(currentPixel);
                    currentPositionColumn++;

                    if (currentPositionColumn === imageWidth) {
                        imagePixelArray.push(currentRowPixels);
                        currentRowPixels = [];
                        currentPositionColumn = 0;
                    }
                }
                return imagePixelArray;
            }

            function getAsciiArray(imagePixelArray, imageWidth, imageHeight) {
                let imageAsciiArray = []
                for (let row = 0; row < imageHeight; row++) {
                    let currentAsciiRow = [];
                    for (let column = 0; column < imageWidth; column++) {
                        currentAsciiRow.push(imagePixelArray[row][column].toAscii());
                    }
                    imageAsciiArray.push(currentAsciiRow);
                }
                return imageAsciiArray;
            }

            function outputAsciiArray(imageAsciiArray) {
                asciiString = '';
                for (let i = 0; i < imageAsciiArray.length; i++) {
                    asciiString = asciiString.concat(imageAsciiArray[i].join(''), '\n');
                }
                document.getElementById('asciiOutput').innerHTML = asciiString;
            }

            class Pixel {
                static characterMap = "`^\",:;Il!i~+_-?][}{1)(|\\/tfjrxnuvczXYUJCLQ0OZmwqpdbkhao*#MW&8%B@$";

                constructor(red, green, blue, alpha) {
                    this.red = red;
                    this.green = green;
                    this.blue = blue;
                    this.alpha = alpha; // TODO: necessary? or able to throw away
                }
                luminosity() {
                    return 0.21 * this.red + 0.72 * this.green + 0.07 * this.blue;
                }
                lightness() {
                    return (Math.max(this.red, this.green, this.blue) + Math.min(this.red, this.green, this.blue)) / 2;
                }
                average() {
                    return (this.red + this.blue + this.green) / 3;
                }

                toAscii(brightnessType) {
                    let percentBrightness;
                    switch(brightnessType) {
                        case 'luminosity':
                            percentBrightness = this.luminosity() / 255; // TODO: double check max lightness/luminosity is 255
                            break;
                        case 'lightness':
                            percentBrightness = this.lightness() / 255;
                            break;
                        case 'average':
                        default:
                            percentBrightness = this.average() / 255;
                    }
                    let asciiChar = Pixel.characterMap[Math.floor(percentBrightness * Pixel.characterMap.length) - 1];
                    if (asciiChar)
                        return asciiChar.repeat(3);
                }
            }
        </script>
        <style>
            #asciiOutput {
                font-size: small;
            }     
        </style>
    </head>
    <body>
        <h1>Asky - ASCII Image Generator</h1>
        <h2>Source image</h2>
        <canvas id="sourceImage"></canvas>
        <h2>ASCII Image</h2>
        <pre id="asciiOutput"></pre>
    </body>
</html>