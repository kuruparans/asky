<html>
    <head>
        <title>Asky - ASCII Image Generator</title>
        <script>
            window.addEventListener('DOMContentLoaded', (event) => {
                let videoCaptureButton = document.getElementById('videoCaptureButton');
                videoCaptureButton.onclick = function() {
                    getMedia();
                };
                let invertButton = document.getElementById('invertButton');
                invertButton.onclick = function() {
                    let [brightnessType, invertedFlag] = readAsciiSettings();
                    readCanvas(brightnessType, invertedFlag);
                };
                loadImage(screenshot=false);
            });

            async function getMedia() {
                let constraints = {'video': true};
                let stream = null;
                try {
                    stream = await navigator.mediaDevices.getUserMedia(constraints);
                    window.stream = stream;
                    let videoElement = document.getElementById('videoSource');
                    videoElement.srcObject = stream;
                } catch(error) {
                    alert('Camera access issue, refresh and try again.');
                    console.log(error);
                    return;
                }
                updateScreen();
            }
            
            function updateScreen() {
                let videoCaptureButton = document.getElementById('videoCaptureButton');
                videoCaptureButton.style.display = 'none';
                let screenshotButton = document.getElementById('screenshotButton');
                screenshotButton.style.display = 'block'
                screenshotButton.onclick = function() {
                    takeScreenshot();
                };
            }

            function takeScreenshot() {
                let videoElement = document.getElementById('videoSource');
                let canvasElement = document.getElementById('sourceImage');
                canvasElement.width = videoElement.videoWidth;
                canvasElement.height = videoElement.videoHeight;
                canvasElement.getContext("2d").drawImage(videoElement, 0, 0);

                loadImage(screenshot=true, videoElement);
            }

            function loadImage(screenshot, sourceMedia) {
                let sourceImage = new Image();
                sourceImage.crossOrigin = 'anonymous';

                if (!screenshot) {
                    let imageName = 'manchette.jpg';
                    sourceImage.src = imageName;
                    sourceImage.onload = function() {
                        loadCanvas(screenshot, sourceImage, this.naturalWidth, this.naturalHeight);
                    };
                } else {
                    loadCanvas(screenshot, sourceMedia);
                }
            }

            function loadCanvas(screenshot, sourceImage, sourceWidth, sourceHeight) {
                let canvasElement = document.getElementById('sourceImage');

                let sourceImageWidth = sourceWidth ? sourceWidth : canvasElement.width;
                let sourceImageHeight = sourceHeight ? sourceHeight : canvasElement.height;
                let windowWidth = window.innerWidth;
                let windowHeight = window.innerHeight;

                let pixelWidthPerCharacter = 1800 / 150; // baseline desktop screen fits 150 characters for 1800px width screen
                let resizedImageWidthFactor = 1;
                if (pixelWidthPerCharacter * sourceImageWidth > windowWidth)
                    resizedImageWidthFactor = windowWidth / (pixelWidthPerCharacter * sourceImageWidth);

                let resizedWidth = Math.round(sourceImageWidth * resizedImageWidthFactor);
                let resizedHeight = Math.round(resizedWidth / sourceImageWidth * sourceImageHeight);

                canvasElement.width = resizedWidth;
                canvasElement.height = resizedHeight;

                let canvasContext = canvasElement.getContext('2d');
                canvasContext.drawImage(sourceImage, 0, 0, resizedWidth, resizedHeight);

                readCanvas();
            }

            function readCanvas(brightnessType, invertedFlag) {
                let canvasElement = document.getElementById('sourceImage');
                let canvasContext = canvasElement.getContext('2d');
                let sourceImageData = canvasContext.getImageData(0, 0, canvasElement.width, canvasElement.height).data;
                let sourceImagePixelArray = readImageData(sourceImageData, canvasElement.width, canvasElement.height);

                let imageAsciiArray = getAsciiArray(sourceImagePixelArray, canvasElement.width, canvasElement.height, brightnessType, invertedFlag);

                outputAsciiArray(imageAsciiArray);
            }

            function readAsciiSettings() {
                let brightnessType = 'average';
                let invertedFlag = document.getElementById('invertButton');
                return [brightnessType, invertedFlag.checked];
            }

            function readImageData(imageData, imageWidth, imageHeight) {
                let imagePixelArray = [];
                let currentPositionColumn = 0;
                let currentRowPixels = [];
                for (let i = 0; i < imageData.length; i += 4) {
                    currentPixel = new Pixel(imageData[i + 0], imageData[i + 1], imageData[i + 2], imageData[i + 3]);
                    currentRowPixels.push(currentPixel);
                    currentPositionColumn++;

                    if (currentPositionColumn === imageWidth) {
                        imagePixelArray.push(currentRowPixels);
                        currentRowPixels = [];
                        currentPositionColumn = 0;
                    }
                }
                return imagePixelArray;
            }

            function getAsciiArray(imagePixelArray, imageWidth, imageHeight, brightnessType, invertedFlag) {
                let imageAsciiArray = []
                if (!brightnessType)
                    brightnessType = 'average';
                for (let row = 0; row < imageHeight; row++) {
                    let currentAsciiRow = [];
                    for (let column = 0; column < imageWidth; column++) {
                        currentAsciiRow.push(imagePixelArray[row][column].toAscii(brightnessType, invertedFlag));
                    }
                    imageAsciiArray.push(currentAsciiRow);
                }
                return imageAsciiArray;
            }

            function outputAsciiArray(imageAsciiArray) {
                asciiString = '';
                for (let i = 0; i < imageAsciiArray.length; i++) {
                    asciiString = asciiString.concat(imageAsciiArray[i].join(''), '\n');
                }
                document.getElementById('asciiOutput').innerHTML = asciiString;
            }

            class Pixel {
                static asciiCharacterMap = "`^\",:;Il!i~+_-?][}{1)(|\\/tfjrxnuvczXYUJCLQ0OZmwqpdbkhao*#MW&8%B@$";

                constructor(red, green, blue, alpha) {
                    this.red = red;
                    this.green = green;
                    this.blue = blue;
                }
                luminosity() {
                    return 0.21 * this.red + 0.72 * this.green + 0.07 * this.blue;
                }
                lightness() {
                    return (Math.max(this.red, this.green, this.blue) + Math.min(this.red, this.green, this.blue)) / 2;
                }
                average() {
                    return (this.red + this.blue + this.green) / 3;
                }

                toAscii(brightnessType, invertedType) {
                    let percentBrightness;
                    switch(brightnessType) {
                        case 'luminosity':
                            percentBrightness = this.luminosity() / 255;
                            break;
                        case 'lightness':
                            percentBrightness = this.lightness() / 255;
                            break;
                        case 'average':
                        default:
                            percentBrightness = this.average() / 255;
                    }
                    if (!invertedType)
                        percentBrightness = 1 - percentBrightness;
                    let asciiCharacterMapIndex = Math.floor(percentBrightness * Pixel.asciiCharacterMap.length) - 1;
                    if (asciiCharacterMapIndex < 0)
                        asciiCharacterMapIndex = 0;
                    let asciiChar = Pixel.asciiCharacterMap[asciiCharacterMapIndex];
                    if (asciiChar)
                        return asciiChar.repeat(2);
                    else
                        console.log('Err', this);
                        return;
                }
            }
        </script>
        <style>
            #sourceImage {
                /* display: none; */
            }
            #asciiOutput {
                font-size: small;
            }
            button {
                background: white;
                color: black;
                padding: 5px;
            }
            #screenshotButton {
                display: none;
            }
        </style>
    </head>
    <body>
        <h1>Asky - ASCII Image Generator</h1>
        <h2>Take a selfie</h2>
        <video id="videoSource" autoplay></video>
        <p><button id="videoCaptureButton">Capture Video</button> <button id="screenshotButton">Take a Screenshot</button></p>
        <p>Brightness type: <input type="radio" id="brightnessTypeLuminosity" name="brightnessType" /><label for="brightnessTypeLuminosity">Luminosity</label> <input type="radio" id="brightnessTypeLightness" name="brightnessType" /><label for="brightnessTypeLightness">Lightness</label> <input type="radio" id="brightnessTypeAverage" checked name="brightnessType" /><label for="brightnessTypeAverage">Average</label></p>
        <p><label for="invertButton">Invert brightness</label>: <input type="checkbox" id="invertButton" /></p>
        <h2>Source image</h2>
        <canvas id="sourceImage"></canvas>
        <h2>ASCII Image</h2>
        <pre id="asciiOutput"></pre>
    </body>
</html>