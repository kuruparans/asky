<html>
    <head>
        <title>Asky - ASCII Image Generator</title>
        <script>
            window.addEventListener('DOMContentLoaded', (event) => {
                loadImage();
            });

            function loadImage() {
                let imageName = 'manchette.jpg';
                let sourceImage = new Image();
                sourceImage.crossOrigin = 'anonymous';
                sourceImage.src = imageName;

                sourceImage.onload = function() {
                    let canvasElement = document.getElementById('sourceImage');

                    let sourceImageWidth = this.naturalWidth;
                    let sourceImageHeight = this.naturalHeight;

                    let windowWidth = window.innerWidth;
                    let windowHeight = window.innerHeight;

                    let pixelWidthPerCharacter = 1800 / 150; // baseline desktop screen fits 150 characters for 1800px width screen
                    let resizedImageWidthFactor = 1;
                    if (pixelWidthPerCharacter * sourceImageWidth > windowWidth)
                        resizedImageWidthFactor = windowWidth / (pixelWidthPerCharacter * sourceImageWidth);
                    
                    let resizedWidth = Math.round(sourceImageWidth * resizedImageWidthFactor);
                    let resizedHeight = Math.round(resizedWidth / sourceImageWidth * sourceImageHeight);

                    canvasElement.width = resizedWidth;
                    canvasElement.height = resizedHeight;

                    let canvasContext = canvasElement.getContext('2d');
                    canvasContext.drawImage(sourceImage, 0, 0, resizedWidth, resizedHeight);

                    let sourceImageData = canvasContext.getImageData(0, 0, resizedWidth, resizedHeight).data;
                    let sourceImagePixelArray = readImageData(sourceImageData, resizedWidth, resizedHeight);

                    let imageAsciiArray = getAsciiArray(sourceImagePixelArray, resizedWidth, resizedHeight);

                    outputAsciiArray(imageAsciiArray);
                };
            }

            function readImageData(imageData, imageWidth, imageHeight) {
                let imagePixelArray = [];
                let currentPositionColumn = 0;
                let currentRowPixels = [];
                for (let i = 0; i < imageData.length; i += 4) {
                    currentPixel = new Pixel(imageData[i + 0], imageData[i + 1], imageData[i + 2], imageData[i + 3]);
                    currentRowPixels.push(currentPixel);
                    currentPositionColumn++;

                    if (currentPositionColumn === imageWidth) {
                        imagePixelArray.push(currentRowPixels);
                        currentRowPixels = [];
                        currentPositionColumn = 0;
                    }
                }
                return imagePixelArray;
            }

            function getAsciiArray(imagePixelArray, imageWidth, imageHeight) {
                let imageAsciiArray = []
                for (let row = 0; row < imageHeight; row++) {
                    let currentAsciiRow = [];
                    for (let column = 0; column < imageWidth; column++) {
                        currentAsciiRow.push(imagePixelArray[row][column].toAscii('lightness'));
                    }
                    imageAsciiArray.push(currentAsciiRow);
                }
                return imageAsciiArray;
            }

            function outputAsciiArray(imageAsciiArray) {
                asciiString = '';
                for (let i = 0; i < imageAsciiArray.length; i++) {
                    asciiString = asciiString.concat(imageAsciiArray[i].join(''), '\n');
                }
                document.getElementById('asciiOutput').innerHTML = asciiString;
            }

            class Pixel {
                static asciiCharacterMap = "`^\",:;Il!i~+_-?][}{1)(|\\/tfjrxnuvczXYUJCLQ0OZmwqpdbkhao*#MW&8%B@$";

                constructor(red, green, blue, alpha) {
                    this.red = red;
                    this.green = green;
                    this.blue = blue;
                }
                luminosity() {
                    return 0.21 * this.red + 0.72 * this.green + 0.07 * this.blue;
                }
                lightness() {
                    return (Math.max(this.red, this.green, this.blue) + Math.min(this.red, this.green, this.blue)) / 2;
                }
                average() {
                    return (this.red + this.blue + this.green) / 3;
                }

                toAscii(brightnessType) {
                    let percentBrightness;
                    switch(brightnessType) {
                        case 'luminosity':
                            percentBrightness = this.luminosity() / 255;
                            break;
                        case 'lightness':
                            percentBrightness = this.lightness() / 255;
                            break;
                        case 'average':
                        default:
                            percentBrightness = this.average() / 255;
                    }
                    percentBrightness = 1 - percentBrightness;
                    let asciiCharacterMapIndex = Math.floor(percentBrightness * Pixel.asciiCharacterMap.length) - 1;
                    if (asciiCharacterMapIndex < 0)
                        asciiCharacterMapIndex = 0;
                    let asciiChar = Pixel.asciiCharacterMap[asciiCharacterMapIndex];
                    if (asciiChar)
                        return asciiChar.repeat(2);
                    else
                        console.log('Err', this);
                        return;
                }
            }
        </script>
        <style>
            #sourceImage {
                /* display: none; */
            }
            #asciiOutput {
                font-size: small;
            }     
        </style>
    </head>
    <body>
        <h1>Asky - ASCII Image Generator</h1>
        <h2>Source image</h2>
        <canvas id="sourceImage"></canvas>
        <h2>ASCII Image</h2>
        <pre id="asciiOutput"></pre>
    </body>
</html>